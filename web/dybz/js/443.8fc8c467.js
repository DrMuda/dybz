"use strict";(self["webpackChunkdybz"]=self["webpackChunkdybz"]||[]).push([[443],{9443:function(e,t,i){i.r(t),i.d(t,{default:function(){return S}});var s=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{attrs:{id:"main"}},[t("div",{staticClass:"nav"},[t("el-button",{staticClass:"nav-btn",attrs:{size:"small"},on:{click:e.load}},[e._v("刷新")]),t("el-button",{staticClass:"nav-btn",attrs:{size:"small"},on:{click:e.toPrev}},[e._v("上一章")]),t("el-button",{staticClass:"nav-btn",attrs:{size:"small"},on:{click:e.toNext}},[e._v("下一章")]),e._l(e.novel.pages,(function(i,s){return t("el-button",{key:i,staticClass:"nav-btn",attrs:{type:e.setPageBtnType(s),size:"small"},on:{click:function(t){return e.toPages(s)}}},[e._v("["+e._s(s+1)+"] ")])}))],2),t("div",{attrs:{id:"main-context"}},[e._l(e.novel.mainContext,(function(i,s){return[!0===new RegExp(/^<br \/>/).test(i)?t("br",{key:i+s}):!0!==new RegExp(/^img:/).test(i)||e.imgAndChar[e.oldNewKey[i.replace("img:","")]]?.char?!0===new RegExp(/^img:/).test(i)&&e.imgAndChar[e.oldNewKey[i.replace("img:","")]]?.char?t("span",{key:i+s+"replace"},[e._v(e._s(e.imgAndChar[e.oldNewKey[i.replace("img:","")]]?.char))]):t("span",{key:i+s+"origin"},[e._v(e._s(i))]):t("editable-img",{key:i+s+"editable-img",attrs:{imgSrc:e.imgAndChar[e.oldNewKey[i.replace("img:","")]]?.img||"#",id:i.replace("img:",""),updateCache:e.updateCache,item:i,newKey:e.oldNewKey[i.replace("img:","")]}})]}))],2),t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"},{name:"show",rawName:"v-show",value:e.loading,expression:"loading"}],attrs:{id:"loading"}})])},a=[],o=(i(7658),i(676)),n=i(5711),r=i(3089),l=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("span",[t("img",{attrs:{src:e.imgSrc||"#"},on:{click:e.onImgClick}}),t("el-dialog",{attrs:{visible:e.dialogIsShow,title:"输入字符",width:"90%","before-close":e.handleClose}},[t("img",{attrs:{src:e.imgSrc||"#"}}),t("el-input",{attrs:{id:"input",size:"small"},model:{value:e.input,callback:function(t){e.input=t},expression:"input"}})],1)],1)},h=[],c=i(6369),g=i(8499);c["default"].use(g.Dialog),c["default"].use(g.Input);var d=c["default"].extend({name:"EditableImg",components:{Dialog:g.Dialog,Input:g.Input},data(){return{dialogIsShow:!1,input:""}},props:{imgSrc:String,id:String,updateCache:Function,item:String,newKey:String},watch:{input(){this.input.length>1&&(this.input=this.input[0])}},methods:{onImgClick:function(){this.dialogIsShow=!0,setTimeout((()=>{document.getElementById("input")?.focus()}),10)},handleClose:function(){this.dialogIsShow=!1,this.updateCache?.(this.newKey,this.input)}}}),m=d,u=i(1001),p=(0,u.Z)(m,l,h,!1,null,"293a5186",null),v=p.exports,y=i(6797),f=i.n(y),C=i(9248);c["default"].use(g.Loading.directive);var P=c["default"].extend({components:{EditableImg:v},data(){return{novel:{title:"",pages:[],currPage:0,prev:"",next:"",mainContext:[]},nextPageNovel:null,imgAndChar:n.Z.get(),oldNewKey:{},novelId:this.$route.query.id,novelUrl:this.$route.query.url,loading:!1,isPreLoad:!1,tryPreLoadNum:1,maxTryPreloadNum:3,autoRefreshChar:null,cancelTokenList:[],reloadSetTimeout:null,reloadTimeInterval:()=>1e3*Math.random()+3e3}},props:{msg:String},mounted:async function(){let e={};try{e=JSON.parse(sessionStorage.getItem("cachePage")||"{}")}catch(t){console.error(t),e={}}try{this.oldNewKey=JSON.parse(localStorage.getItem("oldNewKey")||"{}")}catch(t){console.error(t),this.oldNewKey={}}e.novelUrl===this.novelUrl&&e.novelId===this.novelId?(this.novel=e.novel||{currPage:0,mainContext:[],next:"",pages:[],prev:"",title:""},this.nextPageNovel=e.nextPageNovel||null):(await this.load(),this.toTop(),this.startReload()),this.autoRefreshChar=setInterval((()=>{if(JSON.stringify(n.Z.get())!==JSON.stringify(this.imgAndChar)&&(this.imgAndChar=n.Z.get()),localStorage.getItem("oldNewKey")!==JSON.stringify(this.oldNewKey))try{this.oldNewKey=JSON.parse(localStorage.getItem("oldNewKey")||"{}")}catch(t){console.error(t),this.oldNewKey={}}}),500)},beforeDestroy(){this.autoRefreshChar&&clearInterval(this.autoRefreshChar),this.setHistory(),this.cachePage()},beforeRouteLeave(e,t,i){this.novelId=this.$route.query.id,this.novelUrl=this.$route.query.url,i()},methods:{cachePage:function(){if(this.novel.mainContext?.length>0){const e={novelId:this.novelId,novelUrl:this.novelUrl,novel:this.novel,nextPageNovel:this.nextPageNovel};sessionStorage.setItem("cachePage",JSON.stringify(e))}},setHistory:function(){if(this.novel.mainContext?.length>0){const e=this.novelUrl.split("/"),t=this.novel.pages[this.novel.currPage]?.replace?.(".html",""),i=JSON.parse(`{"data":${localStorage.getItem("novelList")}}`).data||[],s=i.findIndex((e=>e.id.toString()===this.novelId.toString()));s>-1&&(i[s]={...i[s],history:{title:this.novel.title,url:`/${e[1]}/${e[2]}/${t||e[3]}`}}),localStorage.setItem("novelList",JSON.stringify(i)),localStorage.setItem("lastUpdate",f()().format("YYYY-MM-DD HH:mm:ss"))}},load:function(){return new Promise((e=>{let t=!1;!this.isPreLoad&&(this.loading=!0);try{let i=this.novelUrl;if(this.isPreLoad&&(this.novel.pages[this.novel.currPage+1]?i="/"+this.novelUrl.split("/")[1]+"/"+this.novelUrl.split("/")[2]+"/"+this.novel.pages[this.novel.currPage+1].replace(".html",""):this.novel.next?i=this.novel.next.replace(".html",""):e()),i){const s=this.getWebData(i,this.cancelTokenList);s.then((async i=>{this.cancelTokenList=[];const s=this.initContent(i)||{},a=JSON.parse(localStorage.getItem("oldNewKey")||"{}");let o=!1;(0,r.Z)(((e,t)=>{a[e]=t,o=!0})).then((()=>{let i=s.mainContext;o&&localStorage.setItem("oldNewKey",JSON.stringify(a)),this.isPreLoad?this.nextPageNovel={...s,mainContext:i}:this.novel={...s,mainContext:i},this.loading=!1,this.imgAndChar=n.Z.get(),t=!0,this.isPreLoad=!1,e()}))}),(i=>{console.error(i),this.cancelTokenList=[],"中断请求"!==i&&(this.reloadSetTimeout&&(clearTimeout(this.reloadSetTimeout),this.reloadSetTimeout=null),this.reloadSetTimeout=setTimeout((()=>{this.isPreLoad&&this.tryPreLoadNum<this.maxTryPreloadNum&&!t?(this.tryPreLoadNum+=1,this.load()):(this.isPreLoad=!1,e())}),this.reloadTimeInterval())),e()}))}}catch(i){console.error(i),this.isPreLoad||(0,g.Message)({showClose:!0,message:"出错了",type:"error",duration:1e3}),!this.isPreLoad&&(this.loading=!1),this.cancelTokenList=[],e()}}))},startReload(){this.reloadSetTimeout&&(clearTimeout(this.reloadSetTimeout),this.reloadSetTimeout=null),this.nextPageNovel=null,this.isPreLoad=!0,this.tryPreLoadNum=1,this.maxTryPreloadNum=3,this.reloadSetTimeout=setTimeout((()=>{this.load()}),this.reloadTimeInterval())},toPrev:async function(){this.novel.prev?(this.novelUrl=this.novel.prev.replace(".html",""),this.$router.replace({query:{...this.$route.query,url:this.novelUrl}}),this.isPreLoad&&await new Promise((e=>{this.reloadSetTimeout&&(clearTimeout(this.reloadSetTimeout),this.reloadSetTimeout=null),this.cancelTokenList.forEach((e=>{e("中断请求")})),this.cancelTokenList=[],setTimeout(e,10)})),this.isPreLoad=!1,await this.load(),this.toTop(),this.startReload()):(0,g.Message)({message:"已是第一章",type:"info",showClose:!0,duration:1e3})},toNext:async function(){this.novel.next?(this.novelUrl=this.novel.next.replace(".html",""),this.$router.replace({query:{...this.$route.query,url:this.novelUrl}}),void 0===this.novel.currPage||this.novel.currPage===this.novel.pages.length-1?this.nextPageNovel?(this.novel=JSON.parse(JSON.stringify(this.nextPageNovel)),this.toTop()):this.isPreLoad?(this.loading=!0,await new Promise((e=>{this.$watch("loading",(()=>{e()}))})),this.novel=JSON.parse(JSON.stringify(this.nextPageNovel)),this.nextPageNovel=null,this.isPreLoad=!1,this.loading=!1,this.toTop()):(this.isPreLoad=!1,await this.load(),this.toTop()):(this.isPreLoad&&await new Promise((e=>{this.reloadSetTimeout&&(clearTimeout(this.reloadSetTimeout),this.reloadSetTimeout=null),this.cancelTokenList.forEach((e=>{e("中断请求")})),this.cancelTokenList=[],setTimeout(e,10)})),this.isPreLoad=!1,await this.load(),this.toTop()),this.startReload()):(0,g.Message)({message:"已是最后一章",type:"info",showClose:!0,duration:1e3})},async toPages(e){if(this.novel.currPage!==e){const t=this.novelUrl.split("/");this.novelUrl=`/${t[1]}/${t[2]}/${this.novel.pages[e].replace(".html","")}`,this.$router.replace({query:{...this.$route.query,url:this.novelUrl}}),this.novel.currPage+1===e?this.nextPageNovel?(this.novel=JSON.parse(JSON.stringify(this.nextPageNovel)),this.toTop()):this.isPreLoad?(this.loading=!0,await new Promise((e=>{this.$watch("loading",(()=>{e()}))})),this.novel=JSON.parse(JSON.stringify(this.nextPageNovel)),this.toTop()):(this.isPreLoad=!1,await this.load(),this.toTop()):(this.isPreLoad&&await new Promise((e=>{this.reloadSetTimeout&&(clearTimeout(this.reloadSetTimeout),this.reloadSetTimeout=null),this.cancelTokenList.forEach((e=>{e("中断请求")})),this.cancelTokenList=[],setTimeout(e,10)})),this.isPreLoad=!1,await this.load(),this.toTop()),this.startReload()}},toTop(){document?.getElementById("main-context")?.scrollTo({top:0,behavior:"smooth"})},setPageBtnType(e){if(e===this.novel.currPage)return"primary"},updateCache(e,t){this.imgAndChar[e].char=t,n.Z.setCharByKey(e,t)},getWebData(e,t){return e=e||this.novelUrl,t=t||this.cancelTokenList,new Promise(((i,s)=>{C.yj(e,t,this.$store.state.currNovelChanel).then(function(e){const t=e.data.content;i(t)}.bind(this)).catch((e=>{!this.isPreLoad&&(0,g.Message)({showClose:!0,message:"加载失败",type:"error",duration:1e3}),this.loading=!1,"中断请求"===e.message?s("中断请求"):s(e.message)}))}))},initContent(e){const t={currPage:0,mainContext:[],next:"",pages:[],prev:"",title:""};this.imgAndChar=n.Z.get(),e=e.replace(/\n/g,""),e=e.replace(/\r/g,""),e=e.replace(/src=/g,"my-src=");const i=document.createElement("div");let s=new RegExp("<body.*/body>").exec(e)?.[0];s=s?.replace("body","div");const a=(0,o.Z)(s)[0];a&&i?.appendChild(a),t.title=i.getElementsByClassName("page-title")?.[0]?.innerHTML;const r=i.getElementsByClassName("chapterPages")?.[0]?.childNodes;if(r?.length>0)for(let o=0;o<r.length;o+=1){const e=r[o],i=e.getAttribute("href")||"";t.pages||(t.pages=[]),t.pages=[...t.pages,i],"curr"===e.getAttribute("class")&&(t.currPage=o)}else t.pages=[];const l=i.getElementsByClassName("mod page-control")?.[1]?.getElementsByClassName("prev")?.[0],h=i.getElementsByClassName("mod page-control")?.[1]?.getElementsByClassName("next")?.[0];t.prev=l?.getAttribute("href")||"",t.next=h?.getAttribute("href")||"";const c=/.html$/;c.test(t.prev)||(t.prev=null),c.test(t.next)||(t.next=null);let g=null;if(g=this.tileEle(i.getElementsByClassName("neirong")[0]),g?.length>0)for(let o=0;o<g.length;o+=1){t.mainContext||(t.mainContext=[]);const e=g[o];if(e instanceof Text){let i=e.textContent;i=i?.replace(/&nbsp;/g,"")||null,i&&t.mainContext.push(i)}else if(e instanceof HTMLImageElement){let i=e.getAttribute("my-src")||"";t.mainContext.push(`img:${i}`),this.oldNewKey[i]&&this.imgAndChar[this.oldNewKey[i]]?.img||(this.imgAndChar[i]={char:null,img:null})}else e instanceof HTMLBRElement?t.mainContext.push("<br />"):t.mainContext.push(e.innerText||"")}else t.mainContext=[];return n.Z.set(this.imgAndChar),t},tileEle(e){const t=e.childNodes;if(t&&t?.length>0){let e=[];for(let i=0;i<t?.length;i++){const s=t[i],a=s?.style;"5px"!==a?.height&&(e=[...e,...this.tileEle(t[i])])}return e}return[e]}}}),w=P,N=(0,u.Z)(w,s,a,!1,null,"a8d514d0",null),S=N.exports},5711:function(e,t,i){function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}i.d(t,{Z:function(){return o}});class a{constructor(){s(this,"imgAndChar",{}),this._refresh()}_refresh(e){if(e)localStorage.setItem("imgAndChar",JSON.stringify(this.imgAndChar));else{const e=localStorage.getItem("imgAndChar");if(e)try{this.imgAndChar=JSON.parse(e)}catch(t){this.imgAndChar={},localStorage.setItem("imgAndChar","{}")}else this.imgAndChar={},localStorage.setItem("imgAndChar","{}")}}get(){return this.imgAndChar}getByKey(e){return this.imgAndChar[e]}set(e){this.imgAndChar=e,this._refresh(!0)}setByKey(e,t){this.imgAndChar[e]=t,this._refresh(!0)}setCharByKey(e,t){this.imgAndChar[e]||(this.imgAndChar[e]={char:null,img:null}),this.imgAndChar[e].char=t,this._refresh(!0)}setImgByKey(e,t){this.imgAndChar[e]||(this.imgAndChar[e]={char:null,img:null}),this.imgAndChar[e].img=t,this._refresh(!0)}}var o=new a},639:function(e,t,i){var s=i(5711),a=i(9248),o=i(8499);const n=10;t["Z"]=async()=>{const e=localStorage.getItem("ocr"),t=localStorage.getItem("ocrToken");if(e&&"no"!==e&&t){(0,o.Message)({message:"正在使用百度ocr， 注意使用量",type:"warning",duration:1e3,showClose:!0});const i=s.Z.get(),r=Object.keys(i);for(let o=0;o<r.length;o+=1){const n=r[o],l=i[n];!l.char&&l.img&&await new Promise(((o,r)=>{const h=document.createElement("canvas"),c=h.getContext("2d");if(h.setAttribute("height","25"),h.setAttribute("width","25"),c){c.fillStyle="#fff",c.fillRect(0,0,25,25);const g=new Image;g.src=l.img||"",g.onload=()=>{c.drawImage(g,0,0),a.XG({url:e,method:"post",params:{access_token:t,image:h.toDataURL()}}).then((e=>{s.Z.setCharByKey(n,e.data.words_result?.[0]?.words),i[n]={...i[n],char:e.data.words_result?.[0]?.words},o()}),(()=>{r(),console.error("error")})).catch((e=>{r(),console.error(e)}))}}}))}await new Promise((e=>{setTimeout((()=>{e()}),1e3/n)}))}else e&&"no"!==e&&!t&&(0,o.Message)({message:"无access_token",type:"error",duration:1e3,showClose:!0})}},3089:function(e,t,i){i(7658);var s=i(5711),a=i(9564),o=i.n(a),n=i(639),r=i(9248);t["Z"]=e=>new Promise(((t,i)=>{let a=s.Z.get();const l=[];Object.keys(a).forEach((t=>{t.includes(".png")&&l.push(new Promise(((i,s)=>{r.Pk(t).then((async s=>{const n=await s.data;if("string"===typeof n){const i=o()(n.replace("data:text/html","data:image/png"));a[i]={char:"",img:n.replace("data:text/html","data:image/png")},e instanceof Function&&e(t,i),delete a[t]}i(`success:${t}`)}),(()=>{s(`fail:${t}`)}))})))})),Promise.allSettled(l).then((()=>{s.Z.set(a),(0,n.Z)(),t()}),(()=>{i()}))}))}}]);